# 数字存储2.0 - 日志记录

本文档记录所有添加的调试日志，用于后续清理或放入设置开关。

## 文件位置
`Develop/数字存储2.0/Source/Components/Building_StorageCore.cs`

## 方法
`ConvertPhysicalItemsToVirtualWithReserved()` - 每300 tick执行一次

## 参考项目
`Develop/数字存储por max finished` - 该项目的转换函数 `ConvertPhysicalItemsToVirtual()` **完全没有日志输出**，只在关键操作时输出日志（错误、警告、关键成功）。

## 建议
参考 finished 项目，**转换函数应该没有日志输出**，只在关键操作时输出日志。

---

## 无条件日志（始终输出）

### 1. 函数开始
- **位置**: 第548行
- **内容**: `[数字存储] 开始转换检查，预留数量: {reservedCount}`
- **频率**: 每300 tick一次
- **建议**: 保留，但可以改为仅在 `enableDebugLog` 时输出

### 2. 统计对比（每个Key）
- **位置**: 第634行
- **内容**: `[数字存储] 统计对比: {物品名}, 统计阶段总数: {statStageTotal}, 转换阶段总数: {totalCount}, 预留: {reservedCount}, 堆叠数: {currentThings.Count}, 差异: {totalCount - statStageTotal}`
- **频率**: 每300 tick一次，每个物品类型一条
- **建议**: **重要日志**，用于诊断统计问题。建议保留，但可以改为仅在 `enableDebugLog` 时输出

### 3. 转换结果（每个Key，超出预留时）
- **位置**: 第721行
- **内容**: `[数字存储] 转换结果: {物品名}, 实际: {totalCount}, 预留: {reservedCount}, 需转换: {toConvertCount}, 已收集: {converted}, 差异: {toConvertCount - converted}`
- **频率**: 每300 tick一次，仅在超出预留时输出
- **建议**: **重要日志**，用于诊断转换问题。建议保留，但可以改为仅在 `enableDebugLog` 时输出

### 4. 未超出预留（每个Key，未超出时）
- **位置**: 第733行
- **内容**: `[数字存储] 未超出预留: {物品名}, 实际: {totalCount}, 预留: {reservedCount}, 无需转换`
- **频率**: 每300 tick一次，每个物品类型一条（如果未超出预留）
- **建议**: **可能产生大量日志**，建议改为仅在 `enableDebugLog` 时输出

### 5. 转换检查完成（无转换时）
- **位置**: 第749行
- **内容**: `[数字存储] 本次转换检查完成，无需转换任何物品`
- **频率**: 每300 tick一次（如果无转换）
- **建议**: 可以删除或改为仅在 `enableDebugLog` 时输出

### 6. 准备转换堆叠数
- **位置**: 第753行
- **内容**: `[数字存储] 准备转换 {toConvert.Count} 个堆叠`
- **频率**: 每300 tick一次（如果有转换）
- **建议**: 可以删除或改为仅在 `enableDebugLog` 时输出

### 7. 转换总计
- **位置**: 第785行
- **内容**: `[数字存储] 本次转换总计: {totalConvertedCount} 个物品`
- **频率**: 每300 tick一次（如果有转换）
- **建议**: **重要日志**，建议保留，但可以改为仅在 `enableDebugLog` 时输出

---

## 有条件日志（仅在 `enableDebugLog == true` 时输出）

### 统计阶段详细日志
- **位置**: 第556行、第580行、第586行
- **内容**: 
  - `[数字存储] ========== 开始统计阶段 ==========`
  - `[数字存储] [统计阶段] 发现堆叠: {thing.Label} x{stackCount}, 位置: {thing.Position}, Key: {key}, 该Key累计总计: {totalCountsByKey[key]}, Thing对象ID: {thing.GetHashCode()}`
  - `[数字存储] ========== 统计阶段完成 ==========`
- **频率**: 每300 tick一次，每个堆叠一条
- **建议**: 保留现有条件

### 转换阶段详细日志
- **位置**: 第595行、第608行、第619行、第626行、第638行、第651行、第660行、第670行、第681行、第691行、第705行、第712行、第725行、第737行、第744行、第768行、第789行
- **内容**: 包括：
  - `[数字存储] ========== 开始转换阶段 ==========`
  - `[数字存储] [转换阶段] 开始重新统计Key: {key}, 统计阶段总数: {statStageTotal}, 堆叠数: {currentThings.Count}`
  - `[数字存储] [转换阶段] 重新统计堆叠: {thing.Label} x{currentStackCount}, 位置: {thing.Position}, Thing对象ID: {thing.GetHashCode()}, 累计总计: {totalCount}`
  - `[数字存储] [转换阶段] 跳过无效堆叠: ...`
  - `[数字存储] [转换阶段] 重新统计完成: ...`
  - `[数字存储] [转换阶段] 检测到超出预留: ...`
  - `[数字存储] [转换阶段] 已收集足够数量，停止转换: ...`
  - `[数字存储] [转换阶段] 处理堆叠: ...`
  - `[数字存储] [转换阶段] 整个堆叠转换: ...`
  - `[数字存储] [转换阶段] 部分堆叠转换: ...`
  - `[数字存储] [转换阶段] SplitOff失败: ...`
  - `[数字存储] [转换阶段] 转换收集完成: ...`
  - `[数字存储] [转换阶段] 未超出预留: ...`
  - `[数字存储] ========== 转换阶段完成 ==========`
  - `[数字存储] 转换物品: {thing.Label} x{thing.stackCount}, 转换前虚拟存储: {beforeCount}, 转换后虚拟存储: {afterCount}`
  - `[数字存储] [详细] 本次转换总计: {totalConvertedCount} 个物品`
- **频率**: 每300 tick一次，每个堆叠/操作一条
- **建议**: 保留现有条件

---

## 建议的清理方案

### 方案1：参考 finished 项目，删除所有转换日志（最推荐）
参考 finished 项目，转换函数应该没有日志输出，只在关键操作时输出日志。

**删除所有转换相关日志**:
- 第548行：开始转换检查 ❌ 删除
- 第634行：统计对比 ❌ 删除
- 第721行：转换结果 ❌ 删除
- 第733行：未超出预留 ❌ 删除
- 第749行：转换检查完成 ❌ 删除
- 第753行：准备转换堆叠数 ❌ 删除
- 第785行：转换总计 ❌ 删除

**保留的日志**（仅在 `enableDebugLog` 时输出）:
- 所有详细调试日志（已在 `enableDebugLog` 条件内）

**优点**:
- 与 finished 项目保持一致
- 不会产生日志爆炸
- 性能更好（减少字符串拼接和日志输出）

### 方案2：全部放入设置开关
将所有无条件日志改为仅在 `enableDebugLog` 时输出，避免日志爆炸。

**需要修改的日志**:
- 第548行：开始转换检查
- 第634行：统计对比
- 第721行：转换结果
- 第733行：未超出预留
- 第749行：转换检查完成
- 第753行：准备转换堆叠数
- 第785行：转换总计

### 方案3：保留关键日志
只保留最重要的日志，其他放入设置开关。

**保留的日志**:
- 第634行：统计对比（用于诊断统计问题）
- 第721行：转换结果（用于诊断转换问题）
- 第785行：转换总计（用于确认转换成功）

**放入设置开关的日志**:
- 第548行：开始转换检查
- 第733行：未超出预留
- 第749行：转换检查完成
- 第753行：准备转换堆叠数

---

## 修改日期
2024-12-19

## 修改原因
调试统计阶段和转换阶段数量不一致的问题，添加详细日志用于诊断。

